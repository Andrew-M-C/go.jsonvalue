<font size=6>v1.2.x の新機能</font>

[前のページ](./16_1_12_new_feature.md) | [目次](./README.md)

---

- [NewFloat64 と NewFloat32 の変更](#newfloat64-と-newfloat32-の変更)
- [関数型オプションによるオプションの渡し方](#関数型オプションによるオプションの渡し方)
- [NaN と +/-Inf の処理](#nan-と--inf-の処理)
- [デフォルトオプションのオーバーライド対応](#デフォルトオプションのオーバーライド対応)

---

## NewFloat64 と NewFloat32 の変更

このバージョンでは、初の非後方互換機能として `NewFloat64` と `NewFloat32` 関数を導入しています。

v1.2.0 以前では、これらの関数は以下のような形でした：

```go
func NewFloat64(f float64, prec int) *V
func NewFloat32(f float32, prec int) *V
```

パラメータ `prec` は `strconv.FormatFloat` の呼び出しで使用され、対応する `fmt` パラメータは `'f'` に設定されていました。

しかし、[Issue #8](https://github.com/Andrew-M-C/go.jsonvalue/issues/8) により、`'f'` フォーマットがすべての浮動小数点数を表現するのに最適なフォーマットではないことが分かりました。場合によっては、科学記法を使用する方が適切です。そのため、`strconv.FormatFloat` のパラメータを開放する必要がありました。

慎重に検討した結果、非後方互換バージョンをリリースすることに決定しました。変更点は以下の通りです：

- `NewFloat64` と `NewFloat32` から `prec` パラメータを削除しました。フォーマット動作は `encoding/json` と同じ動作を維持します。
- `NewFloat64f` と `NewFloat32f` を追加しました。これらは浮動小数点値、フォーマット、精度を含む `strconv.FormatFloat` と同じオプションパラメータを持ちます。
  - **注意**: JSON 標準に従い、`f`、`E`、`e`、`G`、`g` フォーマットのみがサポートされています。不正な値を受け取った場合、jsonvalue は代わりに `g` を使用します。

---

## 関数型オプションによるオプションの渡し方

v1.2.0 以前では、追加オプションは構造体で定義されていました。v1.2.0 からは、代わりに `OptXxx` 関数を使用してください。

---

## NaN と +/-Inf の処理

セクション [追加オプション](./12_option.md) の「+/-Inf の処理」を参照してください。

---

## デフォルトオプションのオーバーライド対応

```go
func SetDefaultMarshalOptions(opts ...Option)
func ResetDefaultMarshalOptions()
```

jsonvalue では、デフォルトのシリアライズオプションは以下の通りです：

- JSON 標準で明示的に定義されているすべての文字（`", /, \, <, >, &`、垂直/水平タブ、復帰文字、バックスペースを含む）をエスケープします。
- 127 より大きいすべての文字をエスケープします。

しかし、フィードバックによると、これらの厳格なルールはほとんどの場合において必要ありません。そのため、必要なシリアライズルールが明確な場合は、プロセス初期化後に `SetDefaultMarshalOptions` を呼び出して jsonvalue のデフォルトオプションをオーバーライドすることができます。
